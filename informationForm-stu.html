<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>發佈提案 - 芝山圓夢媒合站</title>
  <link rel="icon" href="img/favicon.png" type="image/x-icon">
  <script src="header-component.js" defer></script>
  <script src="footer-component.js" defer></script>
  <link rel="stylesheet" href="css/informationForm-stu.css" />
</head>
<body>
  <header-component></header-component>

  <main class="form-wrapper">
    <form class="proposal-form">
      <h2>發佈提案</h2>

      <label>姓名</label>
      <input type="text" name="name" placeholder="請輸入您的姓名" required />

      <label>科系</label>
      <input type="text" name="department" placeholder="請輸入您的科系" required />
      
      <label>提案摘要</label>
      <input type="text" name="summary" placeholder="請簡要描述" required />

      <label>專案敘述</label>
      <textarea name="description" rows="5" placeholder="詳細描述您的提案內容、目標" required></textarea>

      <label>專案類別</label>
      <select name="category" required>
        <option value="">請選擇類別</option>
        <option value="數位醫療">數位醫療</option>
        <option value="AI應用">AI應用</option>
        <option value="永續環境">永續環境</option>
        <option value="其他">其他</option>
      </select>

      <label>預算範圍</label>
      <input type="number" name="budget" placeholder="請輸入預期的預算金額 (單位：25000–30000)" required />

      <label>截止日期</label>
      <input type="date" name="deadline" required />

      <!-- 將檔案上傳區域改為連結輸入框 -->
      <label>作品集或相關資料連結</label>
      <input type="url" name="attachmentLink" placeholder="請輸入作品集或相關資料連結 (例如：GitHub、Behance、Google Drive 等)" />

      <!-- 註解掉原本的檔案上傳區域 -->
      <!--
      <label>上傳附件文件</label>
      <div class="upload-area">
        <img src="img/upload.png" alt="upload icon" />
        <p>上傳文件</p>
        <input type="file" />
      </div>
      -->

      <button type="submit" class="submit-button">發佈 →</button>
    </form>
  </main>

  <footer-component></footer-component>

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDDJ9_uXb5WgmhRxta4Atzrbo-FE7u_cko",
      authDomain: "ntuedream.firebaseapp.com",
      projectId: "ntuedream",
      storageBucket: "ntuedream.firebasestorage.app",
      messagingSenderId: "1052981554365",
      appId: "1:1052981554365:web:dc971a29c9ba37cdf71bd4",
      measurementId: "G-SF8QTGQC1V"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // 連結驗證函數
    function validateURL(url) {
      if (!url) return true; // 空值是允許的，因為連結是可選的
      
      try {
        new URL(url);
        return true;
      } catch {
        return false;
      }
    }

    // 表單提交處理
    document.querySelector(".proposal-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const form = e.target;
      const submitBtn = form.querySelector('.submit-button');
      const originalText = submitBtn.textContent;
      
      const formData = new FormData(form);
      const attachmentLink = formData.get('attachmentLink');
      
      // 驗證連結格式
      if (attachmentLink && !validateURL(attachmentLink)) {
        alert('請輸入有效的連結格式（例如：https://example.com）');
        return;
      }

      const data = {
        name: formData.get('name'),
        department: formData.get('department'),
        summary: formData.get('summary'),
        description: formData.get('description'),
        category: formData.get('category'),
        budget: parseInt(formData.get('budget')),
        deadline: formData.get('deadline'),
        createdAt: serverTimestamp(),
        type: 'student' // 標記這是學生提案
      };

      // 如果有提供連結，則添加到資料中
      if (attachmentLink) {
        data.attachmentLink = attachmentLink.trim();
      }

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = '提交中...';
        
        await addDoc(collection(db, "proposals"), data);
        alert("提案已成功提交！");
        form.reset();
        
      } catch (err) {
        console.error("送出失敗", err);
        alert("提交失敗，請稍後再試：" + err.message);
        
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
  </script>
</body>
</html>